name: Design Asset Sync

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®9æ™‚ã«å®Ÿè¡Œ
    - cron: '0 9 * * MON'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  # pushã‚¤ãƒ™ãƒ³ãƒˆã§ã¯å®Ÿè¡Œã—ãªã„
  
jobs:
  check-design-updates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Check design changelog
        id: check_changelog
        run: |
          # æœ€æ–°ã®ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´æ—¥ã‚’ãƒã‚§ãƒƒã‚¯
          latest_date=$(grep -E "^## v[0-9]+\.[0-9]+\.[0-9]+ - " docs/DESIGN_CHANGELOG.md | head -1 | sed 's/.*- //')
          echo "latest_design_date=$latest_date" >> $GITHUB_OUTPUT
          
          # 1é€±é–“ä»¥ä¸Šå¤ã„å ´åˆã¯é€šçŸ¥
          if [ -n "$latest_date" ]; then
            last_update=$(date -d "$latest_date" +%s)
            week_ago=$(date -d "1 week ago" +%s)
            
            if [ $last_update -lt $week_ago ]; then
              echo "needs_update=true" >> $GITHUB_OUTPUT
            else
              echo "needs_update=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Create issue for design update
        if: steps.check_changelog.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        env:
          LATEST_DESIGN_DATE: ${{ steps.check_changelog.outputs.latest_design_date }}
        with:
          script: |
            const latestDate = process.env.LATEST_DESIGN_DATE || 'è¨˜éŒ²ãªã—';
            const bodyText = [
              '## ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¢ã‚»ãƒƒãƒˆæ›´æ–°ã®ç¢ºèª',
              '',
              'æœ€æ–°ã®ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´ã‹ã‚‰1é€±é–“ä»¥ä¸ŠçµŒéã—ã¦ã„ã¾ã™ã€‚',
              '',
              '### ç¢ºèªäº‹é …',
              '- [ ] Figmaãƒ•ã‚¡ã‚¤ãƒ«ã«æ–°ã—ã„å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª',
              '- [ ] å¿…è¦ã«å¿œã˜ã¦ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ»ã‚¢ã‚»ãƒƒãƒˆã‚’æ›´æ–°',
              '- [ ] `docs/DESIGN_CHANGELOG.md` ã‚’æ›´æ–°',
              '',
              '### æœ€æ–°ã®è¨˜éŒ²',
              `æœ€çµ‚æ›´æ–°æ—¥: ${latestDate}`,
              '',
              '### ã‚¢ã‚¯ã‚·ãƒ§ãƒ³',
              '1. Figmaãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª: [ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«](FIGMA_URL)',
              '2. å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ design/update-YYYYMMDD ãƒ–ãƒ©ãƒ³ãƒã§æ›´æ–°',
              '3. ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º',
              '',
              '---',
              '*ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*'
            ].join('\n');
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¢ã‚»ãƒƒãƒˆæ›´æ–°ç¢ºèª',
              body: bodyText,
              labels: ['design', 'maintenance']
            });
            
            console.log(`Created issue #${issue.data.number}`);